#!/usr/bin/env bash

#CHANNELS="gmail gnu riseup sinusoides sinusoidal"
CHANNELS="riseup runbox bronze"

afew_command=afew
mbsync_command=mbsync
notmuch_command=notmuch

notify_infinity=100000
notify_delay=10000

do-notify() {
    argument=""
    last_id=`echo $notify_id | sed 's/[^0-9]//g'`
    if [ -n "$last_id" ]; then
        argument="-r $last_id"
        notify_id=$last_id
    fi
    notify_id=`notify-desktop $argument "$@"`
    export notify_id
}

notify_progress() {
    echo "-- $1"
    do-notify -i email -a getmail -t $notify_infinity "Sync email" "$1"
}

notify_finish() {
    echo "== $1"
    do-notify -i email -a getmail -t $notify_delay "Sync email" "$1"
}

notify_finish_ok() {
    echo "== $1"
    last_id=`echo $notify_id | sed 's/[^0-9]//g'`
    action=`notify-send -r $last_id -A default=ok -i email -a getmail "Sync email" "$1"`
    # if action is "default", run email command
    if [ "$action" = "default" ]; then
        email &
    fi
}

kill_children() {
    trap '' INT TERM
    echo
    notify_progress "Shutting down..."
    kill -TERM 0
    wait
    notify_finish "...cancelled."
    exit 1
}

do_sync_email() {
    notify_progress "Fetching..."
    for i in $CHANNELS; do
        echo "   ... fetching $i"
        $mbsync_command $i &
    done
    wait

    notify_progress "Updating database..."
    result_message=`$notmuch_command new | tail -n 1`

    notify_progress "Organizing email..."
    $afew_command --tag --new

    # if result message contains "no new mail", case insensitive
    if echo "$result_message" | grep -iq "no new mail"; then
        notify_finish "$result_message"
    else
        notify_finish_ok "$result_message"
    fi
}

main() {
    trap 'kill_children' INT

    network_state=`nmcli networking connectivity`

    if [ $network_state = 'full' ]
    then
        do_sync_email
    else
        notify_finish "No internet connection!"
        exit 1
    fi

    exit 0
}

main
